了解です。
これまでの議論を **「変額保険システム設計の外観」**として、
**思想 → 構造 → 重要設計ポイント** の順で **Markdown** にまとめます。

---

# 変額保険システム設計の外観（設計思想ベース）

## 1. システム設計の前提思想

### 1.1 商品理解（前提）

* 変額保険は
  **投資信託（特別勘定）＋生命保険（一般勘定）** の複合商品
* 目的は

  * トレードではない
  * 短期最適化ではない
  * **長期・フェーズ型の資産管理**

### 1.2 設計原則（全体を貫く軸）

* 強制清算・即時判断を起こさない
* 人間の判断遅れ・誤りを前提にする
* **再現性・説明責任を最優先**
* 「結果」より「なぜそうなったか」を残す

---

## 2. 全体アーキテクチャ（論理構造）

```
[ 契約者UI ]        [ バックヤードUI ]
      │                    │
      ▼                    ▼
           [ BFF / API層 ]
                    │
        ┌───────────┴───────────┐
        ▼                           ▼
[ 契約・保全ドメイン ]       [ 支払・給付ドメイン ]
        │                           │
        ▼                           ▼
[ 払込・入金管理 ]           [ 決済・会計 ]
        │
        ▼
[ NAV決定・ユニット付与 ]
        │
        ▼
[ 特別勘定（投資） / 一般勘定（保障） ]
```

---

## 3. ドメイン分割の考え方

### 3.1 契約・保全（Policy Administration）

* 契約状態管理（INFORCE / GRACE / LAPSED 等）
* 受取人・住所変更
* 配分変更（スイッチング）
* 契約は **入金詳細と疎結合**

---

### 3.2 払込・入金管理（Billing / Collections）

* 払込方法混在を前提

  * 月払 / 年払 / 一時払 / 追加払
  * 口振 / カード / 振込
* 核となる考え方：

  * **払込方法ではなく「払込取引」を正とする**
  * `PremiumSchedule`（予定）と `PremiumTransaction`（実績）の分離
* 充当ルールは **集中管理（Cash Allocation Engine）**

---

### 3.3 NAV決定・ユニット付与（変額の中核）

#### 設計思想

* NAV適用日は「見た目」より「決定根拠」が重要
* 再計算禁止・確定値主義

#### nav_date 算出

* **1つの純粋関数コア**で決定
* 外部条件はすべて引数（Context）として注入
* 再現性のため **決定結果を永続化**

```text
nav_date = determineNavDate(
  Fact（入金日時・決済確定日時など）,
  Context（ルール・締め時刻・営業日など）
)
```

#### Context設計

* アプリとして一意に決まるもののみ

  * rule_version
  * cutover_time
  * calendar_version
  * settlement_lag
  * timezone
* 例外は **overrideレイヤ**で分離

---

### 3.4 特別勘定 / 一般勘定

* 特別勘定

  * ユニット数 × NAV
  * 株・債券など
* 一般勘定

  * 死亡保障・最低保証
  * 市場価格と非連動

---

### 3.5 給付・支払（Claims & Payout）

* 死亡・満期・解約・年金開始
* 算定は

  ```
  支払額 = max(最低保証, 特別勘定評価額) − 控除
  ```
* 決済は非同期前提（銀行結果待ち）
* 会計・税務・監査ログ必須

---

## 4. UI設計の外観

### 4.1 契約者UI（フロント）

**思想**

* 見る頻度を下げるUI
* 行動を誘発しない

**特徴**

* リアルタイム値動きは見せない
* 日次評価＋評価基準日を明示
* チャートは長期・任意表示
* 強調すべきは

  * 払込累計
  * 現在評価
  * 最低保証

---

### 4.2 バックヤードUI（業務）

**思想**

* 判断を証明するUI

**必須要素**

* 事実（Fact）
* 決定条件（Context）
* 判断結果（Decision）
* 例外（Override）

**重要画面**

* 払込・充当状況
* NAV決定根拠表示
* 例外管理（4-eyes）
* 監査ログ（時系列）

---

## 5. 状態遷移の基本思想

### 契約状態

* 単純・安定
* 入金詳細に引きずられない

### 決済・支払

* 非同期・イベント駆動
* 成否・組戻し前提

---

## 6. この設計が目指すもの（総括）

> **変額保険システムとは
> 市場を当てるためのシステムではなく
> 人間が間違えても致命傷にならないようにするシステム**

* 遅れても破綻しない
* 株100％はフェーズとして許容
* FX的UI・即断を排除
* 再現性・説明責任を最優先

---

## 7. 一文でまとめると

> **変額保険のシステム設計とは
> 「長期・非同期・説明責任」を前提にした
> 状態遷移型金融システム設計である**

---

必要なら次は👇に落とせます。

* DBテーブル一覧（ERイメージ）
* 状態遷移図（Policy / Payment / Claim）
* Springベースのモジュール構成
* 監査・金融庁対応を意識した設計チェックリスト

どこまで具体化しますか？

